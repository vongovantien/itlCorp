variables:
  FRONTEND_IMAGE_CURRENTVER: jackchuong/itl:efms-webapp-frontend-1.4.3

stages:
  - build
  - deploy

build_image_frontend_final:
  stage: build
  image: docker:20.10.9
  script:
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS
    - docker build -f dockerfile-frontend -t $FRONTEND_IMAGE_CURRENTVER ./WebApp
    - docker push $FRONTEND_IMAGE_CURRENTVER
  only:
    refs:
      - feature-itl
    changes:
      - WebApp/**/*
  when: manual

deploy_k8s:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  script:
  #  - kubectl config get-contexts
    - kubectl config use-context efms/eFMS-WebApp:efms-agent
  #  - kubectl apply -f kubernetes-configs/manifest.yaml
    - kubectl -n efms set image deployment.apps/efms-frontend efms-frontend=$FRONTEND_IMAGE_CURRENTVER
    - kubectl -n efms annotate deployment.apps/efms-frontend kubernetes.io/change-cause="upgrade version to $FRONTEND_IMAGE_CURRENTVER"
  only:
    refs:
      - feature-itl
    changes:
      - WebApp/**/*
  when: manual

rollback_k8s:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  script:
    - kubectl config use-context efms/eFMS-WebApp:efms-agent
    - kubectl -n efms rollout history deployment.apps/efms-frontend    
    - kubectl -n efms rollout undo deployment.apps/efms-frontend
  only:
    refs:
      - feature-itl
    changes:
      - WebApp/**/*
  when: manual
